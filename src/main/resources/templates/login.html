<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../static/js/axios.js"></script>
    <script src="../static/js/vue.js"></script>
    <title>Exam</title>
    <link rel="stylesheet" href="../static/css/title.css">
    <link rel="stylesheet" href="../static/css/login.css">
    <script src="../static/js/MD5.js"></script>


</head>
<body >

<div id="now" class="titleBox clear">
    <div class="titleL ">
        <img src="../static/img/logo-mini.png"/>
        <h4>中原工学院在线考试系统</h4>
    </div>
    <div class="titleR" v-if="loginState">
        <img src="../static/img/head.png"/>
        <div class="name">{{loginName}}</div>
    </div>
    <div class="titleR" v-else>
        <a style="margin-right: 0px; color: white" href="/login">登录</a>
    </div>
</div>

<div id="login">
    <div class="login" v-if="!forgetPwd">
        <h3 class="logTit" v-if="student">学生登录</h3>
        <h3 class="logTit" v-else>教师登录</h3>
        <div class="form-group">
            <input type="text"  name="user" v-model="id" class="form-control" placeholder="请输入账号"/>
            <div class="error" v-if="error==1">*账号不可为空</div>
            <div class="error" v-if="error==3">*账号不存在</div>
            <input type="password" name="pwd" v-model="password" class="form-control" placeholder="请输入新密码"/>
            <div class="error" v-if="error==2">*密码不可为空</div>
            <div class="error" v-if="error==4">*密码错误</div>
            <input type="submit" style="width: 100%;padding: 0" value="登录" @click="login()"/>
            <a @click="forgetPwd=!forgetPwd">忘记密码</a>
            <a style="margin-left: 66px;" v-if="student" @click="student=!student;error=-1;">点击切换教师登录</a>
            <a style="margin-left: 66px;" v-else @click="student=!student;error=-1;">点击切换学生登录</a>
        </div>
    </div>
    <div class="login" v-if="forgetPwd">
        <h3 class="logTit"  v-if="student">找回密码(学生)</h3>
        <h3 class="logTit" v-else>找回密码(教师)</h3>
        <div class="form-group">
            <input type="text"  name="user" v-model="id" class="form-control" placeholder="请输入账号"/>
            <div class="error" v-if="error==1">*账号不可为空</div>
            <div class="error" v-if="error==3">*账号不存在</div>
            <input type="email" style="width: 62%;" name="email" v-model="email" class="form-control" placeholder="请输入邮箱"/>
            <input type="submit" @click="sendEmail()" class="forgetPwdBut" style="width: 26%;padding: 0;" value="发送验证码">
            <div class="error" v-if="error==6">*邮箱不可为空</div>
            <input type="text"  name="verificationCode" v-model="verificationCode" class="form-control " placeholder="请输入验证码"/>
            <div class="error" v-if="error==7">*验证码不可为空</div>
            <div class="error" v-if="error==8">*验证码错误</div>
            <input type="password" name="pwd" v-model="newPassword" class="form-control" placeholder="请输入新密码"/>
            <div class="error" v-if="error==2">*密码不可为空</div>
            <div class="error" v-if="error==5">*两次密码不一致</div>
            <input type="password" name="pwd" v-model="newPassword2" class="form-control" placeholder="请确认新密码"/>
            <div class="error" v-if="error==5">*两次密码不一致</div>
            <input class="forgetPwdBut" type="submit" style="width: 100%;padding: 0" value="修改密码" @click="forget()"/>
            <a @click="forgetPwd=!forgetPwd;error=-1;">切换登录</a>
            <a style="margin-left: 33px;" v-if="student" @click="student=!student;error=-1;">点击切换教师找回密码</a>
            <a style="margin-left: 33px;" v-else @click="student=!student;error=-1;">点击切换学生找回密码</a><br>
            <span style="font-size: 10px;padding-left: 14px;color: red;">*找回密码需要绑定邮箱，如果没有绑定邮箱请联系管理员重置密码！</span>
        </div>
    </div>
</div>



</body>

<script type="text/javascript">

    let vm = new Vue({
        el:"#login",
        data(){
            return {
                id: '',
                password:'',

                student:true,
                forgetPwd:false,
                email:'',
                newPassword:'',
                newPassword2:'',
                verificationCode:'',
                error:0

           }
        },
        mounted(){

        },
        methods: {
            login() {

                if (this.id == '') {
                    this.error = 1;
                    return;
                }
                if (this.password == '') {
                    this.error = 2;
                    return;
                }
                let formData = new FormData();
                let url;
                if (this.student) {
                    url = `/login/student`;
                } else {
                    url = `/login/teacher`;
                }
                formData.append('id', this.id);
                formData.append('password', hex_md5(this.password + "/" + "!%^fyuagd&*9"));
                let config = {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }
                axios.post(url, formData, config).then((response) => {
                    console.log(response.data);
                    if (response.data == "1") {
                        alert("登录成功");
                    } else if (response.data == "-1") {
                        this.error = 3;
                        alert("账号不存在");
                    } else {
                        this.error = 4;
                        alert("密码错误");
                    }
                })
            }, forget() {

                if (this.id == '') {
                    this.error = 1;
                    return;
                }
                if (this.newPassword == '') {
                    this.error = 2;
                    return;
                }
                if (this.email == '') {
                    this.error = 6;
                    return;
                }
                if (this.verificationCode == '') {
                    this.error = 7;
                    return;
                }
                if (this.newPassword !== this.newPassword2) {
                    this.error = 5;
                    return;
                }
                let formData = new FormData();
                let url;
                if (this.student) {
                    url = `/login/forgetStudent`;
                } else {
                    url = `/login/forgetTeacher`;
                }

                formData.append('id', this.id);
                formData.append('newPassword', this.newPassword);
                formData.append('verificationCode', this.verificationCode);
                let config = {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }
                axios.post(url, formData, config).then((response) => {
                    console.log(response.data);
                    if (response.data == "1") {
                        alert("修改成功");
                    } else if (response.data == "-1") {
                        this.error = 8;
                        alert("验证码错误");
                    } else if (response.data == "-2") {
                        this.error = 3;
                        alert("账号不存在");
                    }
                })
            }, sendEmail() {
                if (this.email == '') {
                    this.error = 6;
                    return;
                }
                let formData = new FormData();
                let url = '/login/sendUserEmail';
                formData.append('id', this.id);
                formData.append('email', this.email);
                let config = {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }
                axios.post(url, formData, config).then((response) => {
                    console.log(response.data);
                    if (response.data == "1") {
                        alert("邮件已经发出请注意查收");
                    } else if (response.data == "-2") {
                        alert("本账户没有绑定该邮箱，请重试");
                    } else if (response.data == "-1") {
                        this.error = 3;
                        alert("账号不存在");
                    }
                })
            }
        }
    });
    let now = new Vue({
        el: "#now",
        data() {return {loginName:'',loginState:false}},
        mounted(){axios.post("/getNow").then( (response)=> {if (response.data!="-1"){this.loginName = response.data;this.loginState=true}else{this.loginState=false} });}
    })
</script>
</html>

